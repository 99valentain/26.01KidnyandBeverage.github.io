<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Research Portfolio: Beverage & Kidney 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Font: Pretendard -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            color: #F1F5F9;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Logic */
        .glass-base {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .glass-panel {
            @apply glass-base rounded-2xl;
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .gradient-text {
            background: linear-gradient(135deg, #38BDF8 0%, #818CF8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Particle Canvas */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            height: 6px; width: 6px; background-color: #38BDF8; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500 selection:text-white pb-24 relative">

    <canvas id="particle-canvas"></canvas>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-header">
        <div class="max-w-5xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500/10 p-2 rounded-lg border border-indigo-500/20">
                        <i class="ph-fill ph-student text-2xl text-indigo-400"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-white text-lg leading-none tracking-tight">Haneulssi's Lab</h1>
                        <p class="text-[10px] text-slate-400 mt-1 font-medium tracking-wide uppercase">Nutritional Epidemiology â€¢ 2026 Portfolio</p>
                    </div>
                </div>
                <!-- Status -->
                <div id="db-status" class="text-[10px] text-emerald-400 bg-emerald-900/20 border border-emerald-500/20 px-3 py-1.5 rounded-full flex items-center gap-2 font-bold cursor-help transition-all hover:bg-emerald-900/30">
                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span> Online
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1 mt-4 border-t border-white/5 pt-3">
                <a href="#abstract" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-white bg-indigo-600/20 border border-indigo-500/30 rounded-lg hover:bg-indigo-600/30 transition">
                    <i class="ph-bold ph-article"></i> Abstract
                </a>
                <a href="#methodology" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-slate-300 hover:text-white bg-white/5 border border-white/5 rounded-lg hover:bg-white/10 transition">
                    <i class="ph-bold ph-graph"></i> Methods
                </a>
                <a href="#results" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-slate-300 hover:text-white bg-white/5 border border-white/5 rounded-lg hover:bg-white/10 transition">
                    <i class="ph-bold ph-chart-line-up"></i> Results
                </a>
                <a href="#simulator" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-slate-300 hover:text-white bg-white/5 border border-white/5 rounded-lg hover:bg-white/10 transition">
                    <i class="ph-bold ph-flask"></i> Simulator
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 py-8 space-y-12 relative z-10">

        <!-- 1. Abstract / Research Overview -->
        <section id="abstract" class="space-y-6 animate__animated animate__fadeIn">
            <div class="glass-panel p-8 relative overflow-hidden">
                <!-- Background Accent -->
                <div class="absolute -top-24 -right-24 w-64 h-64 bg-indigo-600/20 rounded-full blur-[80px]"></div>
                
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-sky-500/10 text-sky-400 border border-sky-500/20">ORIGINAL RESEARCH</span>
                        <span class="text-xs text-slate-400">Based on Research Notes (Sep 2025 - Jan 2026)</span>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-extrabold mb-6 leading-tight">
                        Association between <span class="gradient-text">Beverage Consumption</span><br>
                        and Kidney Function in Korean Adults
                    </h2>
                    <div class="grid md:grid-cols-3 gap-6 text-sm text-slate-300 border-t border-white/10 pt-6">
                        <div>
                            <h3 class="text-indigo-400 font-bold mb-2 text-xs uppercase tracking-wider">Objective</h3>
                            <p class="leading-relaxed text-xs">í•œêµ­ ì„±ì¸ì˜ ìŒë£Œ ì„­ì·¨ íŒ¨í„´(ì»¤í”¼, ì°¨, ê°€ë‹¹ìŒë£Œ)ì´ ì‹ ì¥ ê¸°ëŠ¥(eGFR)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ê·œëª…í•˜ê³ , íŠ¹íˆ ë¯¹ìŠ¤ì»¤í”¼ì™€ ë¸”ë™ì»¤í”¼ì˜ ì°¨ë³„ì  íš¨ê³¼ë¥¼ ë¶„ì„í•¨.</p>
                        </div>
                        <div>
                            <h3 class="text-indigo-400 font-bold mb-2 text-xs uppercase tracking-wider">Methods</h3>
                            <p class="leading-relaxed text-xs">ì œ9ê¸° êµ­ë¯¼ê±´ê°•ì˜ì–‘ì¡°ì‚¬(2022-2024) ë°ì´í„° í™œìš©. CKD-EPI ê³µì‹ì„ ì´ìš©í•œ eGFR ì‚°ì¶œ. ë‹¤ì¤‘íšŒê·€ë¶„ì„ ë° ì¸µí™”ë¶„ì„ ì‹¤ì‹œ.</p>
                        </div>
                        <div>
                            <h3 class="text-indigo-400 font-bold mb-2 text-xs uppercase tracking-wider">Implication</h3>
                            <p class="leading-relaxed text-xs">ë‹¹ë‡¨ë³‘ ë“± ê³ ìœ„í—˜êµ°ì„ ìœ„í•œ ë§ì¶¤í˜• ìŒë£Œ ì„­ì·¨ ê°€ì´ë“œë¼ì¸ ì œì‹œì— ê¸°ì—¬. ê³µì¤‘ë³´ê±´í•™ì  ê·¼ê±° ë§ˆë ¨.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Methodology (Visualized) -->
        <section id="methodology" class="space-y-4">
            <div class="flex items-center justify-between px-2">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="ph-fill ph-git-merge text-emerald-400"></i> Study Design Framework
                </h3>
                <span class="text-[10px] text-slate-500">Ref: Jan 2026 Note</span>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4">
                <!-- Data Source -->
                <div class="glass-panel p-5 border-l-4 border-l-indigo-500 hover:bg-white/5 transition">
                    <div class="text-2xl mb-2">ğŸ“Š</div>
                    <h4 class="font-bold text-slate-200 text-sm">Data Source</h4>
                    <p class="text-xs text-slate-400 mt-1">KNHANES IX (2022-2024)</p>
                    <p class="text-[10px] text-slate-500 mt-2">N â‰ˆ 15,000 (Expected)</p>
                </div>
                
                <!-- Inclusion/Exclusion -->
                <div class="glass-panel p-5 border-l-4 border-l-amber-500 hover:bg-white/5 transition">
                    <div class="text-2xl mb-2">ğŸ‘¥</div>
                    <h4 class="font-bold text-slate-200 text-sm">Participants</h4>
                    <ul class="text-xs text-slate-400 mt-2 space-y-1 list-disc pl-3">
                        <li>Aged 19-64 years</li>
                        <li>Excluded: Cancer, CVD history</li>
                        <li>Excluded: Missing eGFR/FFQ data</li>
                    </ul>
                </div>
                
                <!-- Variables -->
                <div class="glass-panel p-5 border-l-4 border-l-rose-500 hover:bg-white/5 transition">
                    <div class="text-2xl mb-2">ğŸ“</div>
                    <h4 class="font-bold text-slate-200 text-sm">Key Variables</h4>
                    <ul class="text-xs text-slate-400 mt-2 space-y-1">
                        <li><strong class="text-slate-300">Exp:</strong> Coffee type (Black/Mix), Tea, SSB</li>
                        <li><strong class="text-slate-300">Out:</strong> eGFR (CKD-EPI 2021)</li>
                        <li><strong class="text-slate-300">Con:</strong> BMI, Smoking, HTN, DM</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 3. Results / Hypothesis Visualization -->
        <section id="results" class="grid md:grid-cols-2 gap-6">
            <!-- Chart 1: Coffee Type Impact -->
            <div class="glass-panel p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2">
                        <i class="ph-fill ph-chart-bar text-sky-400"></i> Differential Effects by Coffee Type
                    </h3>
                    <div class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400">Hypothesis Model</div>
                </div>
                <div class="h-[250px] w-full">
                    <canvas id="coffeeTypeChart"></canvas>
                </div>
                <p class="text-[10px] text-slate-500 mt-3">
                    *ë¸”ë™ì»¤í”¼ëŠ” eGFR ê°ì†Œ ìœ„í—˜ì„ ë‚®ì¶”ëŠ” ë°˜ë©´(Protective), ë¯¹ìŠ¤ì»¤í”¼ëŠ” ë‹¹ë¶„/í”„ë¦¼ìœ¼ë¡œ ì¸í•´ ìœ„í—˜ì„ ë†’ì¼ ê²ƒ(Risk Factor)ìœ¼ë¡œ ê°€ì„¤ ì„¤ì • (Dec 2025 Note).
                </p>
            </div>

            <!-- Chart 2: Mechanism (Tea Timing) -->
            <div class="glass-panel p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2">
                        <i class="ph-fill ph-clock-user text-emerald-400"></i> Circadian Rhythm & Tea Intake
                    </h3>
                    <div class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400">Mechanism</div>
                </div>
                <div class="h-[250px] w-full">
                    <canvas id="teaTimingChart"></canvas>
                </div>
                <p class="text-[10px] text-slate-500 mt-3">
                    *ì˜¤ì „ ì‹œê°„ëŒ€(Dawn-Noon) ì°¨ ì„­ì·¨ê°€ ì‹ ì¥ ëŒ€ì‚¬ ë¦¬ë“¬ê³¼ ì¼ì¹˜í•˜ì—¬ eGFR ìœ ì§€ì— ê°€ì¥ ê¸ì •ì ì¼ ê²ƒìœ¼ë¡œ ì˜ˆìƒ (Nov 2025 Note).
                </p>
            </div>
        </section>

        <!-- 4. Interactive Simulator -->
        <section id="simulator" class="glass-panel p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent opacity-50"></div>
            
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="ph-fill ph-game-controller text-indigo-400"></i> Public Health Intervention Model
                    </h2>
                    <p class="text-slate-500 text-xs mt-1">Simulating eGFR response to daily beverage choices</p>
                </div>
                <button onclick="window.resetDrinks()" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg border border-white/10 transition flex items-center gap-1">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i> Reset Model
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-8 items-center">
                <!-- Visual Feedback -->
                <div class="flex flex-col items-center justify-center p-6 bg-slate-900/50 rounded-2xl border border-white/5 relative">
                    <div class="relative mb-6">
                        <div id="kidney-char" class="text-[100px] transition-all duration-300 drop-shadow-2xl filter hover:brightness-110 cursor-pointer select-none" onclick="window.pokeKidney()">ğŸ«˜</div>
                        <div id="status-badge" class="absolute -top-2 -right-4 bg-emerald-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg border border-emerald-400 animate-bounce">
                            Optimal
                        </div>
                    </div>
                    
                    <div class="w-full space-y-2">
                        <div class="flex justify-between text-xs font-medium text-slate-400">
                            <span>Predicted Condition</span>
                            <span id="score-val">100%</span>
                        </div>
                        <div class="w-full bg-slate-950 rounded-full h-3 overflow-hidden border border-white/5">
                            <div id="health-bar" class="bg-gradient-to-r from-emerald-500 to-teal-400 h-full w-full transition-all duration-500 relative">
                                <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                            </div>
                        </div>
                        <p id="status-desc" class="text-center text-[10px] text-slate-500 mt-2">í•­ì‚°í™” íš¨ê³¼ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Intervention Controls -->
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.addDrink('tea')" class="group bg-emerald-900/10 hover:bg-emerald-900/30 border border-emerald-500/20 hover:border-emerald-500/40 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <span class="text-2xl block mb-1">ğŸµ</span>
                            <div class="text-xs font-bold text-slate-200">Green/Black Tea</div>
                            <div class="text-[10px] text-emerald-400 font-medium">+3 (Polyphenols)</div>
                            <span id="count-tea" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>

                        <button onclick="window.addDrink('black')" class="group bg-indigo-900/10 hover:bg-indigo-900/30 border border-indigo-500/20 hover:border-indigo-500/40 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <span class="text-2xl block mb-1">â˜•</span>
                            <div class="text-xs font-bold text-slate-200">Black Coffee</div>
                            <div class="text-[10px] text-indigo-400 font-medium">+2 (Antioxidants)</div>
                            <span id="count-black" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>

                        <button onclick="window.addDrink('mix')" class="group bg-amber-900/10 hover:bg-amber-900/30 border border-amber-500/20 hover:border-amber-500/40 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <span class="text-2xl block mb-1">ğŸ¬</span>
                            <div class="text-xs font-bold text-slate-200">Mix Coffee</div>
                            <div class="text-[10px] text-amber-500 font-medium">-5 (Sugar/Fat)</div>
                            <span id="count-mix" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>

                        <button onclick="window.addDrink('ssb')" class="group bg-rose-900/10 hover:bg-rose-900/30 border border-rose-500/20 hover:border-rose-500/40 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <span class="text-2xl block mb-1">ğŸ¥¤</span>
                            <div class="text-xs font-bold text-slate-200">SSB (Soda/Juice)</div>
                            <div class="text-[10px] text-rose-500 font-medium">-10 (Fructose)</div>
                            <span id="count-ssb" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>
                    </div>

                    <label class="flex items-center gap-3 p-3 bg-slate-900/40 rounded-xl border border-white/5 cursor-pointer hover:border-indigo-500/30 transition group select-none">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="check-diabetes" class="peer sr-only" onchange="window.updateKidneyStatus()">
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-rose-600"></div>
                        </div>
                        <span class="text-xs text-slate-400 group-hover:text-slate-200 transition">Comorbidity: Diabetes (High Risk)</span>
                    </label>
                </div>
            </div>
        </section>

        <!-- 5. AI Research Assistant -->
        <section id="chat" class="glass-panel flex flex-col h-[600px] overflow-hidden">
            <div class="p-5 border-b border-white/5 flex justify-between items-center bg-slate-900/30">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-2.5 h-2.5 bg-indigo-500 rounded-full absolute -right-0.5 -bottom-0.5 border-2 border-slate-900 animate-pulse"></div>
                        <span class="text-3xl">ğŸ§‘â€ğŸ’»</span>
                    </div>
                    <div>
                        <span class="font-bold text-white text-sm block">Researcher Cho (AI Assistant)</span>
                        <span class="text-[10px] text-indigo-400 block font-medium">Research Notes (Sep '25 - Jan '26) Loaded</span>
                    </div>
                </div>
                <div class="flex gap-2">
                     <span class="text-[10px] text-slate-500 border border-white/5 px-2 py-1 rounded">Interactive</span>
                </div>
            </div>
            
            <div id="chat-window" class="flex-1 p-5 overflow-y-auto space-y-6 bg-transparent scroll-smooth">
                <div class="flex gap-4 animate__animated animate__fadeIn">
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center border border-white/10 text-lg">ğŸ§‘â€ğŸ’»</div>
                    <div class="bg-slate-800/60 backdrop-blur-sm p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-200 max-w-[85%] chat-content shadow-sm">
                        ì•ˆë…•í•˜ì„¸ìš”! ì¡°í•˜ëŠ˜ ì—°êµ¬ì›ë‹˜ì˜ <strong>9ì›”~1ì›” ì—°êµ¬ë…¸íŠ¸</strong>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„ ì¤€ë¹„ë¥¼ ë§ˆì³¤ìŠµë‹ˆë‹¤.<br><br>
                        ì£¼ìš” í•™ìŠµ ë‚´ìš©:<br>
                        - KNHANES 9ê¸° ë°ì´í„° í™œìš© ê³„íš<br>
                        - ë¯¹ìŠ¤ì»¤í”¼ì˜ ìœ„í•´ì„± vs ë¸”ë™ì»¤í”¼ì˜ ì´ì <br>
                        - ì°¨ ì„­ì·¨ ì‹œê°„(ì˜¤ì „)ê³¼ ì‹ ì¥ ê¸°ëŠ¥ì˜ ìƒê´€ê´€ê³„<br><br>
                        ë…¼ë¬¸ ì‘ì„±ì— í•„ìš”í•œ êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-slate-900/50 border-t border-white/5">
                <div class="relative">
                    <input type="text" id="chat-input" placeholder="Ask about research methodology or results..." class="w-full bg-slate-950/50 border border-slate-700 text-white rounded-xl pl-4 pr-12 py-3.5 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none placeholder-slate-600">
                    <button onclick="window.handleChat()" class="absolute right-2 top-2 p-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition active:scale-95">
                        <i class="ph-bold ph-paper-plane-right text-lg"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <section class="text-center pt-8 pb-4">
            <p class="text-slate-600 text-[10px] font-medium tracking-widest uppercase">Â© 2026 Researcher Haneulssi .</p>
            <div class="inline-flex items-center gap-2 mt-3 px-3 py-1 bg-slate-900/50 border border-white/5 rounded-full text-[10px] text-slate-500">
                <i class="ph-fill ph-eye"></i>
                <span id="visit-count" class="font-mono font-bold text-indigo-400">...</span>
            </div>
        </section>

    </main>

    <!-- Firebase & Main Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, getDoc, setDoc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // === Configuration ===
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const GEMINI_API_KEY = "AIzaSyDUbyxJarLwFPXHnM7y3nSSeNdrJ0-BSSU";

        let db = null;
        let auth = null;
        let user = null;
        let isLocalMode = false;

        // --- Chart.js Setup ---
        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#94a3b8', font: { size: 10, family: 'Pretendard' } } },
                tooltip: { 
                    backgroundColor: 'rgba(15, 23, 42, 0.95)', 
                    titleColor: '#f8fafc', 
                    bodyColor: '#cbd5e1',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    padding: 10,
                    cornerRadius: 8
                }
            },
            scales: {
                y: { 
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }, 
                    ticks: { color: '#64748b', font: { size: 10 } },
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { color: '#64748b', font: { size: 10 } } 
                }
            }
        };

        // Chart 1: Coffee Type Impact (Hypothesis from Dec/Jan Note)
        const ctxCoffee = document.getElementById('coffeeTypeChart').getContext('2d');
        new Chart(ctxCoffee, {
            type: 'bar',
            data: {
                labels: ['Non-Drinker', 'Black Coffee', 'Mix Coffee', 'SSB'],
                datasets: [{
                    label: 'Risk of CKD (Hypothetical OR)',
                    data: [1.0, 0.78, 1.25, 1.45], 
                    backgroundColor: [
                        'rgba(148, 163, 184, 0.5)', // Ref
                        'rgba(129, 140, 248, 0.7)', // Protective
                        'rgba(251, 191, 36, 0.7)',  // Risk
                        'rgba(244, 63, 94, 0.7)'    // High Risk
                    ],
                    borderColor: [
                        'rgba(148, 163, 184, 1)',
                        'rgba(129, 140, 248, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(244, 63, 94, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                ...commonChartOptions,
                plugins: { ...commonChartOptions.plugins, legend: { display: false } },
                scales: {
                    ...commonChartOptions.scales,
                    y: { ...commonChartOptions.scales.y, min: 0, title: { display: true, text: 'Odds Ratio (Reference=1.0)', color: '#475569' } }
                }
            }
        });

        // Chart 2: Tea Timing (Mechanism from Nov 2025 Note)
        const ctxTea = document.getElementById('teaTimingChart').getContext('2d');
        new Chart(ctxTea, {
            type: 'line',
            data: {
                labels: ['Dawn', 'Morning', 'Afternoon', 'Evening', 'Night'],
                datasets: [
                    {
                        label: 'Benefit to eGFR',
                        data: [85, 95, 70, 50, 40], // Peak in Morning
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#064E3B'
                    }
                ]
            },
            options: {
                ...commonChartOptions,
                scales: {
                    y: { display: false }, // Conceptual chart
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        });

        // --- Particle Effect ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        const particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.2;
                this.vy = (Math.random() - 0.5) * 0.2;
                this.size = Math.random() * 2;
                this.alpha = Math.random() * 0.3;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0) this.x = width; if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height; if (this.y > height) this.y = 0;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.fill();
            }
        }
        for (let i = 0; i < 50; i++) particles.push(new Particle());
        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        // --- Firebase & Local Mode ---
        function enableLocalMode(reason) {
            if (isLocalMode) return;
            isLocalMode = true;
            const statusEl = document.getElementById('db-status');
            if (statusEl) {
                statusEl.innerHTML = '<span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span> Local Mode';
                statusEl.className = "text-[10px] text-amber-500 bg-amber-900/20 border border-amber-500/20 px-3 py-1.5 rounded-full flex items-center gap-2 font-bold cursor-help";
            }
            loadLocalVisits();
        }

        async function initFirebase() {
            if (!firebaseConfig) { enableLocalMode("No Config"); return; }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        const statusEl = document.getElementById('db-status');
                        if(statusEl) {
                            statusEl.innerHTML = '<span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(52,211,153,0.8)]"></span> Online';
                            statusEl.className = "text-[10px] text-emerald-400 bg-emerald-900/20 border border-emerald-500/20 px-3 py-1.5 rounded-full flex items-center gap-2 font-bold cursor-help";
                        }
                        updateVisitCount();
                    }
                });
            } catch (e) { enableLocalMode(e.message); }
        }
        initFirebase();

        async function updateVisitCount() {
            if (!db || !user) return;
            const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'meta', 'visits');
            try {
                await updateDoc(counterRef, { count: increment(1) }).catch(async (e) => {
                    if (e.code === 'not-found') try { await setDoc(counterRef, { count: 1 }); } catch(err) {}
                });
                onSnapshot(counterRef, (doc) => {
                    if (doc.exists()) document.getElementById('visit-count').innerText = doc.data().count.toLocaleString();
                });
            } catch (e) { loadLocalVisits(); }
        }

        function loadLocalVisits() {
            let v = parseInt(localStorage.getItem('local_visits') || '0') + 1;
            localStorage.setItem('local_visits', v);
            const vc = document.getElementById('visit-count');
            if(vc) vc.innerText = v.toLocaleString();
        }

        // --- Simulator Logic (Refined based on Notes) ---
        const counts = { black: 0, tea: 0, mix: 0, ssb: 0 };
        const states = [
            { limit: 30, title: "High Risk", badgeColor: "bg-rose-500", desc: "ë‹¹ë¶„ê³¼ ì²¨ê°€ë¬¼ ì„­ì·¨ê°€ ê³¼ë„í•©ë‹ˆë‹¤. (SSB/Mix Warning)" },
            { limit: 60, title: "Caution", badgeColor: "bg-amber-500", desc: "ë¯¹ìŠ¤ì»¤í”¼ ì„­ì·¨ë¥¼ ì¤„ì´ê³  ë¸”ë™ì»¤í”¼ë¡œ ì „í™˜ì„ ê³ ë ¤í•˜ì„¸ìš”." },
            { limit: 85, title: "Good", badgeColor: "bg-blue-500", desc: "ì–‘í˜¸í•©ë‹ˆë‹¤. ì˜¤ì „ ì‹œê°„ëŒ€ ì°¨ ì„­ì·¨ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤." },
            { limit: 101, title: "Optimal", badgeColor: "bg-emerald-500", desc: "í•­ì‚°í™” íš¨ê³¼ê°€ ê¸°ëŒ€ë˜ëŠ” ì´ìƒì ì¸ íŒ¨í„´ì…ë‹ˆë‹¤." }
        ];

        window.addDrink = (t) => { 
            counts[t]++;
            const char = document.getElementById('kidney-char');
            char.classList.remove('animate__rubberBand', 'animate__headShake');
            void char.offsetWidth;
            if(t === 'mix' || t === 'ssb') char.classList.add('animate__headShake');
            else char.classList.add('animate__rubberBand');
            updateUI(t); 
        };
        
        window.resetDrinks = () => { 
            for(let k in counts) counts[k]=0; 
            updateUI(); 
        };

        window.pokeKidney = () => {
             const char = document.getElementById('kidney-char');
             char.classList.remove('animate__rubberBand');
             void char.offsetWidth;
             char.classList.add('animate__rubberBand');
        }

        function updateUI(t) {
            if(t) document.getElementById(`count-${t}`).innerText = counts[t];
            else document.querySelectorAll('[id^="count-"]').forEach(e=>e.innerText='0');

            let score = 100 + (counts.black*2) + (counts.tea*3) - (counts.mix*5) - (counts.ssb*10);
            if(document.getElementById('check-diabetes').checked) score -= (counts.mix*2 + counts.ssb*5);
            score = Math.max(0, Math.min(100, score));

            const s = states.find(s => score < s.limit) || states[3];
            
            document.getElementById('score-val').innerText = score + "%";
            document.getElementById('status-badge').innerText = s.title;
            document.getElementById('status-badge').className = `absolute -top-2 -right-4 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg border border-white/20 animate-bounce ${s.badgeColor}`;
            document.getElementById('status-desc').innerText = s.desc;
            
            const bar = document.getElementById('health-bar');
            bar.style.width = `${score}%`;
            
            if(score < 40) bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r from-rose-600 to-red-500`;
            else if(score < 70) bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r from-amber-500 to-orange-400`;
            else bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r from-emerald-500 to-teal-400`;
            
            bar.innerHTML = '<div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>';
        }
        window.updateKidneyStatus = () => updateUI();

        // --- AI Logic (Updated Persona) ---
        window.handleChat = async () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            
            const win = document.getElementById('chat-window');
            win.innerHTML += `
                <div class="flex gap-4 justify-end animate__animated animate__fadeInUp">
                    <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none text-sm max-w-[85%] chat-content shadow-lg border border-indigo-500/50">${msg}</div>
                </div>`;
            input.value=''; 
            win.scrollTop = win.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            win.innerHTML += `
                <div id="${loadingId}" class="flex gap-4 mt-2">
                    <div class="w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center border border-white/10">ğŸ§‘â€ğŸ’»</div>
                    <div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-white/5 shadow-sm">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>`;
            win.scrollTop = win.scrollHeight;
            
            let reply = "Server busy.";
            try {
                if(GEMINI_API_KEY) {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: msg }] }], systemInstruction: { parts: [{ text: "ë‹¹ì‹ ì€ ì¡°í•˜ëŠ˜ ì—°êµ¬ì›ì˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ì—°êµ¬ë…¸íŠ¸ ë‚´ìš©ì„ ìˆ™ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤: 1) 9ì›”-10ì›”: ì„ í–‰ì—°êµ¬ ì¡°ì‚¬ (ì»¤í”¼/ì°¨ëŠ” ê¸ì •ì , ê°€ë‹¹ìŒë£ŒëŠ” ë¶€ì •ì ). 2) 11ì›”: ë©”ì»¤ë‹ˆì¦˜ ì—°êµ¬ (ì°¨ ì„­ì·¨ íƒ€ì´ë°-ì˜¤ì „, ìƒì²´ë¦¬ë“¬). 3) 12ì›”-1ì›”: ì—°êµ¬ ì„¤ê³„ (KNHANES 9ê¸° 2022-2024 ë°ì´í„° ì‚¬ìš©, CKD-EPI ê³µì‹ ì‚¬ìš©, 19-64ì„¸ ì„±ì¸ ëŒ€ìƒ). ë‹µë³€ì€ ì—°êµ¬ì› ì¡°í•˜ëŠ˜ì˜ ê´€ì ì—ì„œ ì „ë¬¸ì ì´ê³  ë…¼ë¦¬ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. í•œêµ­ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”." }] } })
                    });
                    const data = await res.json();
                    if(data.candidates && data.candidates[0].content) {
                        reply = marked.parse(data.candidates[0].content.parts[0].text);
                    }
                }
            } catch(e) { reply = "Network Error."; }
            
            const loader = document.getElementById(loadingId);
            if(loader) loader.remove();

            win.innerHTML += `
                <div class="flex gap-4 animate__animated animate__fadeInUp">
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center text-lg border border-white/10">ğŸ§‘â€ğŸ’»</div>
                    <div class="bg-slate-800/60 backdrop-blur-sm p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-200 max-w-[85%] chat-content shadow-sm">
                        ${reply}
                    </div>
                </div>`;
            win.scrollTop = win.scrollHeight;
        };
        
        document.getElementById('chat-input').addEventListener('keypress', (e)=>{if(e.key==='Enter') window.handleChat()});
        updateUI();
    </script>
</body>
</html>
