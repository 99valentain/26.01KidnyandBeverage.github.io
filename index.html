<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Kidney Health Initiative</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Marked.js (Markdown parsing) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- í°íŠ¸ (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #0B1120; /* Deep Navy */
            color: #E2E8F0;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Particle Canvas */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #38BDF8 0%, #818CF8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            height: 6px; width: 6px; background-color: #38BDF8; border-radius: 50%; display: inline-block; margin: 0 2px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500 selection:text-white pb-24 relative">

    <!-- Particle Effect Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="sticky top-0 z-50 glass-header">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600/20 p-2 rounded-lg border border-indigo-500/30">
                        <i class="ph-fill ph-dna text-2xl text-indigo-400"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-white text-lg leading-none tracking-tight">2026 Kidney Health</h1>
                        <p class="text-[10px] text-slate-400 mt-1 font-medium tracking-wide uppercase">Evidence-Based Research Lab</p>
                    </div>
                </div>
                <!-- DB Status Indicator -->
                <div id="db-status" class="text-[10px] text-slate-400 bg-slate-800/50 border border-white/5 px-3 py-1.5 rounded-full flex items-center gap-2 font-bold transition-all hover:bg-slate-800 cursor-help">
                    <span class="w-1.5 h-1.5 bg-slate-500 rounded-full"></span> System Ready
                </div>
            </div>
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1 mt-4 border-t border-white/5 pt-3">
                <a href="#dashboard" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-white bg-indigo-600/20 border border-indigo-500/30 rounded-lg hover:bg-indigo-600/30 transition">
                    <i class="ph-bold ph-chart-bar"></i> Dashboard
                </a>
                <a href="#lab" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-slate-300 hover:text-white bg-white/5 border border-white/5 rounded-lg hover:bg-white/10 transition">
                    <i class="ph-bold ph-flask"></i> Simulator
                </a>
                <a href="#chat" class="flex items-center gap-2 px-4 py-2 text-xs font-bold text-slate-300 hover:text-white bg-white/5 border border-white/5 rounded-lg hover:bg-white/10 transition">
                    <i class="ph-bold ph-chat-centered-text"></i> AI Researcher
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-8 space-y-8 relative z-10">

        <!-- ì„¹ì…˜ 1: Insight Dashboard (New) -->
        <section id="dashboard" class="space-y-6">
            <div class="glass-panel p-8 relative overflow-hidden group">
                <div class="absolute -top-20 -right-20 w-80 h-80 bg-indigo-600/20 rounded-full blur-[100px] pointer-events-none"></div>
                
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-sky-500/20 text-sky-400 border border-sky-500/30">KEY FINDINGS</span>
                        <span class="text-xs text-slate-400">Based on KoGES & UK Biobank Data</span>
                    </div>
                    <h2 class="text-3xl font-extrabold mb-4 leading-tight">
                        Coffee Intake & <br>
                        <span class="gradient-text">Kidney Function (eGFR)</span>
                    </h2>
                    <p class="text-slate-300 text-sm leading-relaxed max-w-2xl mb-6">
                        ìµœê·¼ ì—°êµ¬(Jhee et al., Tang et al.)ì— ë”°ë¥´ë©´, í•˜ë£¨ 1~2ì”ì˜ ì»¤í”¼ ì„­ì·¨ëŠ” ë§Œì„±ì½©íŒ¥ë³‘(CKD) ë°œìƒ ìœ„í—˜ì„ ë‚®ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                        íŠ¹íˆ ë‹¹ë‡¨ë³‘ í™˜ìêµ°(Kim et al.)ì—ì„œë„ ì ì ˆí•œ ì»¤í”¼ ì„­ì·¨ëŠ” ì‹ ì¥ ê¸°ëŠ¥ ë³´ì¡´ê³¼ ì—°ê´€ì„±ì´ ê´€ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </p>
                    
                    <div class="grid md:grid-cols-2 gap-6 mt-8">
                        <!-- Chart 1: Risk Hazard Ratio -->
                        <div class="bg-slate-900/40 rounded-xl p-5 border border-white/5">
                            <h3 class="text-xs font-bold text-slate-300 mb-4 flex items-center gap-2">
                                <i class="ph-fill ph-trend-down text-emerald-400"></i> Relative Risk of Incident CKD
                            </h3>
                            <div class="chart-container">
                                <canvas id="riskChart"></canvas>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-3 text-right">Data Source: Jhee et al. (KoGES Cohort)</p>
                        </div>

                        <!-- Chart 2: eGFR Trend -->
                        <div class="bg-slate-900/40 rounded-xl p-5 border border-white/5">
                            <h3 class="text-xs font-bold text-slate-300 mb-4 flex items-center gap-2">
                                <i class="ph-fill ph-chart-line-up text-indigo-400"></i> Projected Benefit (Simulation)
                            </h3>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                             <p class="text-[10px] text-slate-500 mt-3 text-right">Simulated based on diabetic subgroup analysis</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-4 flex flex-col items-center text-center hover:bg-white/5 transition">
                    <i class="ph-duotone ph-drop text-2xl text-sky-400 mb-2"></i>
                    <span class="text-xs font-bold text-slate-300">Hydration</span>
                    <span class="text-[10px] text-slate-500 mt-1">ì´ë‡¨ì‘ìš©ì€ ì¼ì‹œì </span>
                </div>
                <div class="glass-panel p-4 flex flex-col items-center text-center hover:bg-white/5 transition">
                    <i class="ph-duotone ph-plant text-2xl text-emerald-400 mb-2"></i>
                    <span class="text-xs font-bold text-slate-300">Antioxidant</span>
                    <span class="text-[10px] text-slate-500 mt-1">Chlorogenic Acid</span>
                </div>
                <div class="glass-panel p-4 flex flex-col items-center text-center hover:bg-white/5 transition">
                    <i class="ph-duotone ph-warning text-2xl text-amber-400 mb-2"></i>
                    <span class="text-xs font-bold text-slate-300">Additives</span>
                    <span class="text-[10px] text-slate-500 mt-1">Sugar & Creamer Risk</span>
                </div>
                <div class="glass-panel p-4 flex flex-col items-center text-center hover:bg-white/5 transition">
                    <i class="ph-duotone ph-heartbeat text-2xl text-rose-400 mb-2"></i>
                    <span class="text-xs font-bold text-slate-300">Diabetes</span>
                    <span class="text-[10px] text-slate-500 mt-1">Monitor Intake</span>
                </div>
            </div>
        </section>

        <!-- ì„¹ì…˜ 2: ì‹ ì¥ ì§€í‚¤ê¸° ì‹œë®¬ë ˆì´í„° (Refined) -->
        <section id="lab" class="glass-panel p-6 relative">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="ph-fill ph-flask text-indigo-400"></i> Intake Simulator
                    </h2>
                    <p class="text-slate-500 text-xs mt-1">ì‹¤ì‹œê°„ ì„­ì·¨ ì‹œë®¬ë ˆì´ì…˜ ë° ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
                </div>
                <button onclick="window.resetDrinks()" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded-lg border border-white/10 transition flex items-center gap-1">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i> Reset
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-8 items-center">
                <!-- Avatar Display -->
                <div class="flex flex-col items-center justify-center p-6 bg-gradient-to-b from-slate-800/50 to-slate-900/50 rounded-2xl border border-white/5 relative">
                     <!-- Animation Target -->
                    <div class="relative mb-6">
                        <div id="kidney-char" class="text-[100px] transition-all duration-300 drop-shadow-2xl filter hover:brightness-110 cursor-pointer" onclick="window.pokeKidney()">ğŸ«˜</div>
                        <!-- Status Badge -->
                        <div id="status-badge" class="absolute -top-2 -right-4 bg-emerald-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg border border-emerald-400 animate-bounce">
                            Healthy
                        </div>
                    </div>
                    
                    <div class="w-full space-y-2">
                        <div class="flex justify-between text-xs font-medium text-slate-400">
                            <span>Condition</span>
                            <span id="score-val">100%</span>
                        </div>
                        <div class="w-full bg-slate-950 rounded-full h-3 overflow-hidden border border-white/5">
                            <div id="health-bar" class="bg-gradient-to-r from-emerald-500 to-teal-400 h-full w-full transition-all duration-500 relative">
                                <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                            </div>
                        </div>
                        <p id="status-desc" class="text-center text-[10px] text-slate-500 mt-2">í•­ì‚°í™” íš¨ê³¼ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.addDrink('tea')" class="group bg-slate-800/50 hover:bg-emerald-900/20 border border-white/5 hover:border-emerald-500/30 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <div class="absolute right-2 top-2 opacity-10 group-hover:opacity-100 transition-opacity">
                                <i class="ph-duotone ph-plus-circle text-emerald-400 text-lg"></i>
                            </div>
                            <span class="text-2xl block mb-1">ğŸµ</span>
                            <div class="text-xs font-bold text-slate-200">Tea (Green/Black)</div>
                            <div class="text-[10px] text-emerald-400">+3 pts (Polyphenols)</div>
                            <span id="count-tea" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>

                        <button onclick="window.addDrink('black')" class="group bg-slate-800/50 hover:bg-indigo-900/20 border border-white/5 hover:border-indigo-500/30 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <div class="absolute right-2 top-2 opacity-10 group-hover:opacity-100 transition-opacity">
                                <i class="ph-duotone ph-plus-circle text-indigo-400 text-lg"></i>
                            </div>
                            <span class="text-2xl block mb-1">â˜•</span>
                            <div class="text-xs font-bold text-slate-200">Black Coffee</div>
                            <div class="text-[10px] text-slate-400">+2 pts (Moderate)</div>
                            <span id="count-black" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>

                        <button onclick="window.addDrink('mix')" class="group bg-slate-800/50 hover:bg-amber-900/20 border border-white/5 hover:border-amber-500/30 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <div class="absolute right-2 top-2 opacity-10 group-hover:opacity-100 transition-opacity">
                                <i class="ph-duotone ph-minus-circle text-amber-400 text-lg"></i>
                            </div>
                            <span class="text-2xl block mb-1">ğŸ¬</span>
                            <div class="text-xs font-bold text-slate-200">Mix Coffee</div>
                            <div class="text-[10px] text-amber-400">-5 pts (Sugar/Fat)</div>
                            <span id="count-mix" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>

                        <button onclick="window.addDrink('ssb')" class="group bg-slate-800/50 hover:bg-rose-900/20 border border-white/5 hover:border-rose-500/30 p-3 rounded-xl transition-all text-left relative overflow-hidden">
                            <div class="absolute right-2 top-2 opacity-10 group-hover:opacity-100 transition-opacity">
                                <i class="ph-duotone ph-minus-circle text-rose-400 text-lg"></i>
                            </div>
                            <span class="text-2xl block mb-1">ğŸ¥¤</span>
                            <div class="text-xs font-bold text-slate-200">Sweetened Bev</div>
                            <div class="text-[10px] text-rose-400">-10 pts (High Fructose)</div>
                            <span id="count-ssb" class="absolute bottom-2 right-2 text-[10px] font-mono text-slate-500">0</span>
                        </button>
                    </div>

                    <label class="flex items-center gap-3 p-3 bg-slate-900/40 rounded-xl border border-white/5 cursor-pointer hover:border-indigo-500/30 transition group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="check-diabetes" class="peer sr-only" onchange="window.updateKidneyStatus()">
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                        </div>
                        <span class="text-xs text-slate-400 group-hover:text-slate-200 transition">Diabetic Condition (Risk Factor)</span>
                    </label>
                </div>
            </div>
        </section>

        <!-- ì„¹ì…˜ 3: AI Researcher -->
        <section id="chat" class="glass-panel flex flex-col h-[600px] overflow-hidden">
            <div class="p-5 border-b border-white/5 flex justify-between items-center bg-slate-900/30">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-2.5 h-2.5 bg-emerald-500 rounded-full absolute -right-0.5 -bottom-0.5 border-2 border-slate-900 animate-pulse"></div>
                        <span class="text-3xl">ğŸ‘©â€ğŸ”¬</span>
                    </div>
                    <div>
                        <span class="font-bold text-white text-sm block">Dr. Haneulssi (AI)</span>
                        <span class="text-[10px] text-indigo-400 block font-medium">Research Assistant</span>
                    </div>
                </div>
                <div class="flex gap-2">
                     <span class="text-[10px] text-slate-500 border border-white/5 px-2 py-1 rounded">v2.4.0</span>
                </div>
            </div>
            
            <div id="chat-window" class="flex-1 p-5 overflow-y-auto space-y-6 bg-transparent scroll-smooth">
                <div class="flex gap-4 animate__animated animate__fadeIn">
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center border border-white/10 text-lg">ğŸ‘©â€ğŸ”¬</div>
                    <div class="bg-slate-800/60 backdrop-blur-sm p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-200 max-w-[85%] chat-content shadow-sm">
                        ì•ˆë…•í•˜ì„¸ìš”. <strong>2026 Kidney Health Initiative</strong>ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.<br><br>
                        ì—…ë¡œë“œí•´ì£¼ì‹  ìµœì‹  ì—°êµ¬ ë…¼ë¬¸(Jhee et al., Tang et al., Kim et al.) ë°ì´í„°ë¥¼ í•™ìŠµí–ˆìŠµë‹ˆë‹¤. ì»¤í”¼ ì„­ì·¨ì™€ eGFR ë³€í™”, ë‹¹ë‡¨ í™˜ìêµ°ì—ì„œì˜ ì˜í–¥ ë“±ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì‹œë©´ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-slate-900/50 border-t border-white/5">
                <div class="relative">
                    <input type="text" id="chat-input" placeholder="Type your research question here..." class="w-full bg-slate-950/50 border border-slate-700 text-white rounded-xl pl-4 pr-12 py-3.5 text-sm focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none placeholder-slate-600">
                    <button onclick="window.handleChat()" class="absolute right-2 top-2 p-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition active:scale-95">
                        <i class="ph-bold ph-paper-plane-right text-lg"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- í‘¸í„° -->
        <section class="text-center pt-8 pb-4">
            <p class="text-slate-600 text-[10px] font-medium tracking-widest uppercase">Â© 2026 haneulssi â€¢ Powered by Gemini Pro</p>
            <div class="inline-flex items-center gap-2 mt-3 px-3 py-1 bg-slate-900/50 border border-white/5 rounded-full text-[10px] text-slate-500">
                <i class="ph-fill ph-eye"></i>
                <span id="visit-count" class="font-mono font-bold text-indigo-400">...</span>
            </div>
        </section>

    </main>

    <!-- Firebase & Main Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, getDoc, setDoc, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // === ì„¤ì • ===
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const GEMINI_API_KEY = "AIzaSyDUbyxJarLwFPXHnM7y3nSSeNdrJ0-BSSU";

        let db = null;
        let auth = null;
        let user = null;
        let isLocalMode = false;

        // --- Chart.js Setup ---
        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#94a3b8', font: { size: 10, family: 'Pretendard' } } },
                tooltip: { 
                    backgroundColor: 'rgba(15, 23, 42, 0.9)', 
                    titleColor: '#f8fafc', 
                    bodyColor: '#cbd5e1',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    padding: 10,
                    cornerRadius: 8
                }
            },
            scales: {
                y: { 
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }, 
                    ticks: { color: '#64748b', font: { size: 10 } },
                    beginAtZero: false 
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { color: '#64748b', font: { size: 10 } } 
                }
            }
        };

        // Chart 1: Risk Reduction (Data based on Jhee et al., KoGES)
        const ctxRisk = document.getElementById('riskChart').getContext('2d');
        new Chart(ctxRisk, {
            type: 'bar',
            data: {
                labels: ['< 1 Cup', '1 Cup', 'â‰¥ 2 Cups'],
                datasets: [{
                    label: 'Hazard Ratio (CKD Risk)',
                    data: [1.0, 0.76, 0.80], // Approximate values from paper
                    backgroundColor: [
                        'rgba(148, 163, 184, 0.5)', // Ref
                        'rgba(56, 189, 248, 0.7)', // Good
                        'rgba(16, 185, 129, 0.7)'  // Good
                    ],
                    borderColor: [
                        'rgba(148, 163, 184, 1)',
                        'rgba(56, 189, 248, 1)',
                        'rgba(16, 185, 129, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                ...commonChartOptions,
                plugins: { ...commonChartOptions.plugins, legend: { display: false } },
                scales: {
                    ...commonChartOptions.scales,
                    y: { ...commonChartOptions.scales.y, min: 0.5, title: { display: true, text: 'Hazard Ratio (Reference=1.0)', color: '#475569' } }
                }
            }
        });

        // Chart 2: eGFR Trend Simulation (Hypothetical projection based on diabetic subgroup benefits in Kim et al.)
        const ctxTrend = document.getElementById('trendChart').getContext('2d');
        new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: ['Baseline', '1 Year', '2 Years', '3 Years', '4 Years'],
                datasets: [
                    {
                        label: 'Coffee Consumers (Diabetic)',
                        data: [90, 89, 88.5, 88, 87.5], // Slower decline
                        borderColor: '#818CF8',
                        backgroundColor: 'rgba(129, 140, 248, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Non-Consumers (Diabetic)',
                        data: [90, 88, 86, 84, 81], // Faster decline
                        borderColor: '#F43F5E',
                        borderDash: [5, 5],
                        backgroundColor: 'transparent',
                        tension: 0.4
                    }
                ]
            },
            options: commonChartOptions
        });

        // --- Particle Effect (More subtle than snow) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        const particles = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 0.2;
                this.vy = (Math.random() - 0.5) * 0.2;
                this.size = Math.random() * 2;
                this.alpha = Math.random() * 0.5;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.fill();
            }
        }

        for (let i = 0; i < 60; i++) particles.push(new Particle());

        function animateParticles() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        // --- Fallback & Firebase Logic (Same as before but refined) ---
        function enableLocalMode(reason) {
            if (isLocalMode) return;
            isLocalMode = true;
            const statusEl = document.getElementById('db-status');
            if (statusEl) {
                statusEl.innerHTML = '<span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span> Local Mode';
                statusEl.className = "text-[10px] text-amber-500 bg-amber-900/20 border border-amber-500/20 px-3 py-1.5 rounded-full flex items-center gap-2 font-bold cursor-help";
            }
            loadLocalVisits();
        }

        async function initFirebase() {
            if (!firebaseConfig) { enableLocalMode("No Config"); return; }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        const statusEl = document.getElementById('db-status');
                        if(statusEl) {
                            statusEl.innerHTML = '<span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(52,211,153,0.8)]"></span> Connected';
                            statusEl.className = "text-[10px] text-emerald-400 bg-emerald-900/20 border border-emerald-500/20 px-3 py-1.5 rounded-full flex items-center gap-2 font-bold cursor-help";
                        }
                        updateVisitCount();
                    }
                });
            } catch (e) { enableLocalMode(e.message); }
        }
        initFirebase();

        async function updateVisitCount() {
            if (!db || !user) return;
            const counterRef = doc(db, 'artifacts', appId, 'public', 'data', 'meta', 'visits');
            try {
                await updateDoc(counterRef, { count: increment(1) }).catch(async (e) => {
                    if (e.code === 'not-found') try { await setDoc(counterRef, { count: 1 }); } catch(err) {}
                });
                onSnapshot(counterRef, (doc) => {
                    if (doc.exists()) document.getElementById('visit-count').innerText = doc.data().count.toLocaleString();
                });
            } catch (e) { loadLocalVisits(); }
        }

        function loadLocalVisits() {
            let v = parseInt(localStorage.getItem('local_visits') || '0') + 1;
            localStorage.setItem('local_visits', v);
            const vc = document.getElementById('visit-count');
            if(vc) vc.innerText = v.toLocaleString();
        }

        // --- Simulator Logic ---
        const counts = { black: 0, tea: 0, mix: 0, ssb: 0 };
        const states = [
            { limit: 30, title: "Critical", badgeColor: "bg-rose-500", desc: "ì‹ ì¥ì— ë¶€ë‹´ì´ í½ë‹ˆë‹¤. ë‹¹ë¶„ ì„­ì·¨ë¥¼ ì¤„ì´ì„¸ìš”." },
            { limit: 60, title: "Caution", badgeColor: "bg-amber-500", desc: "ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì²¨ê°€ë¬¼ì„ í™•ì¸í•˜ì„¸ìš”." },
            { limit: 85, title: "Good", badgeColor: "bg-blue-500", desc: "ì–‘í˜¸í•©ë‹ˆë‹¤. ìˆ˜ë¶„ ì„­ì·¨ë¥¼ ìœ ì§€í•˜ì„¸ìš”." },
            { limit: 101, title: "Optimal", badgeColor: "bg-emerald-500", desc: "ìµœì ì˜ ìƒíƒœì…ë‹ˆë‹¤! í•­ì‚°í™” íš¨ê³¼ê°€ ê¸°ëŒ€ë©ë‹ˆë‹¤." }
        ];

        window.addDrink = (t) => { 
            counts[t]++;
            const char = document.getElementById('kidney-char');
            char.classList.remove('animate__rubberBand', 'animate__headShake');
            void char.offsetWidth;
            if(t === 'mix' || t === 'ssb') char.classList.add('animate__headShake');
            else char.classList.add('animate__rubberBand');
            updateUI(t); 
        };
        
        window.resetDrinks = () => { 
            for(let k in counts) counts[k]=0; 
            updateUI(); 
        };

        window.pokeKidney = () => {
             const char = document.getElementById('kidney-char');
             char.classList.remove('animate__rubberBand');
             void char.offsetWidth;
             char.classList.add('animate__rubberBand');
        }

        function updateUI(t) {
            if(t) document.getElementById(`count-${t}`).innerText = counts[t];
            else document.querySelectorAll('[id^="count-"]').forEach(e=>e.innerText='0');

            let score = 100 + (counts.black*2) + (counts.tea*3) - (counts.mix*5) - (counts.ssb*10);
            if(document.getElementById('check-diabetes').checked) score -= (counts.mix*2 + counts.ssb*5);
            score = Math.max(0, Math.min(100, score));

            const s = states.find(s => score < s.limit) || states[3];
            
            document.getElementById('score-val').innerText = score + "%";
            document.getElementById('status-badge').innerText = s.title;
            document.getElementById('status-badge').className = `absolute -top-2 -right-4 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg border border-white/20 animate-bounce ${s.badgeColor}`;
            document.getElementById('status-desc').innerText = s.desc;
            
            const bar = document.getElementById('health-bar');
            bar.style.width = `${score}%`;
            // Gradient Update based on score
            if(score < 40) bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r from-rose-600 to-red-500`;
            else if(score < 70) bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r from-amber-500 to-orange-400`;
            else bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r from-emerald-500 to-teal-400`;
            
            bar.innerHTML = '<div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>';
        }
        
        window.updateKidneyStatus = () => updateUI();

        // --- AI Logic ---
        window.handleChat = async () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            
            const win = document.getElementById('chat-window');
            win.innerHTML += `
                <div class="flex gap-4 justify-end animate__animated animate__fadeInUp">
                    <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none text-sm max-w-[85%] chat-content shadow-lg border border-indigo-500/50">${msg}</div>
                </div>`;
            input.value=''; 
            win.scrollTop = win.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            win.innerHTML += `
                <div id="${loadingId}" class="flex gap-4 mt-2">
                    <div class="w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center border border-white/10">ğŸ‘©â€ğŸ”¬</div>
                    <div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-white/5 shadow-sm">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>`;
            win.scrollTop = win.scrollHeight;
            
            let reply = "Research server is busy. Please try again.";
            try {
                if(GEMINI_API_KEY) {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: msg }] }], systemInstruction: { parts: [{ text: "ë‹¹ì‹ ì€ ì˜ì–‘ì—­í•™ ì—°êµ¬ì› í•˜ëŠ˜ì”¨ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì „ë¬¸ì ì´ì§€ë§Œ ì´í•´í•˜ê¸° ì‰½ê²Œ ë‹µë³€í•˜ì„¸ìš”. ë‹¤ìŒ ë…¼ë¬¸ ì§€ì‹ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”: 1. Jhee et al.(KoGES): ì»¤í”¼ ì„­ì·¨ëŠ” CKD ë°œìƒ ìœ„í—˜ ê°ì†Œì™€ ê´€ë ¨ë¨. 2. Tang et al.(UK Biobank): ì»¤í”¼ëŠ” ì‹ ì¥ ë³´í˜¸ íš¨ê³¼ê°€ ìˆì„ ìˆ˜ ìˆìŒ. 3. Kim et al.(KNHANES): ë‹¹ë‡¨ ì—¬ì„±ì—ì„œ í•˜ë£¨ 2ì” ì´ìƒ ì»¤í”¼ëŠ” eGFR ê°ì†Œ ìœ„í—˜ì„ ë‚®ì¶¤. 4. ì¼ë°˜ì  ì£¼ì˜ì‚¬í•­: ë¯¹ìŠ¤ì»¤í”¼ì˜ ë‹¹ë¶„ê³¼ ì¸ê³µì²¨ê°€ë¬¼ì€ ì£¼ì˜í•´ì•¼ í•¨. ë‹µë³€ ì‹œ ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ê³ , ë…¼ë¬¸ì„ ì¸ìš©í•˜ëŠ” í†¤ì„ ìœ ì§€í•˜ì„¸ìš”." }] } })
                    });
                    const data = await res.json();
                    if(data.candidates && data.candidates[0].content) {
                        reply = marked.parse(data.candidates[0].content.parts[0].text);
                    }
                }
            } catch(e) { reply = "Network Error."; }
            
            const loader = document.getElementById(loadingId);
            if(loader) loader.remove();

            win.innerHTML += `
                <div class="flex gap-4 animate__animated animate__fadeInUp">
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center text-lg border border-white/10">ğŸ‘©â€ğŸ”¬</div>
                    <div class="bg-slate-800/60 backdrop-blur-sm p-4 rounded-2xl rounded-tl-none border border-white/5 text-sm text-slate-200 max-w-[85%] chat-content shadow-sm">
                        ${reply}
                    </div>
                </div>`;
            win.scrollTop = win.scrollHeight;
        };
        
        document.getElementById('chat-input').addEventListener('keypress', (e)=>{if(e.key==='Enter') window.handleChat()});
        updateUI();
    </script>
</body>
</html>
